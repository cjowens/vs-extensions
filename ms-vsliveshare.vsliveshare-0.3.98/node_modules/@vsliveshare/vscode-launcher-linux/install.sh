#
# Copyright Â© Microsoft Corporation
# All rights reserved.
#
# Licensed under the MIT License. See LICENSE-CODE in the project root for details.
#
#!/usr/bin/env bash
cd "$(dirname "$0")"

INSTALL_DIR="$2"
PREFIX=""
if [ "$3" = true ]; then
    PREFIX="sudo "
fi

LAUNCHER_INSTALL_DIR=${INSTALL_DIR}/vsliveshare
DESKTOP_INSTALL_DIR=${INSTALL_DIR}/applications
echo "(i) Launcher install folder: ${LAUNCHER_INSTALL_DIR}"
echo "(i) Desktop install folder: ${DESKTOP_INSTALL_DIR}"

# Deploy launcher
${PREFIX}mkdir -p "${LAUNCHER_INSTALL_DIR}"
${PREFIX}cp -f ./vsls-launcher "${LAUNCHER_INSTALL_DIR}" &> /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Failed to copy launcher to ${LAUNCHER_INSTALL_DIR}"
    exit 1
fi
${PREFIX}sed -i -e "2iVSLS_CLI_PATH=\"$1\"" "${LAUNCHER_INSTALL_DIR}/vsls-launcher" &> /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Failed to update CLI path in launcher"
    exit 1
fi
${PREFIX}chmod +wx "${LAUNCHER_INSTALL_DIR}/vsls-launcher"  &> /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Failed to set launcher execute permisions"
    exit 1
fi

# Copy desktop file to a temp location, replace the path in it wiht the real path
${PREFIX}cp -f ./vsls-launcher.desktop ${LAUNCHER_INSTALL_DIR}  &> /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Failed to copy temp desktop file to ${LAUNCHER_INSTALL_DIR}"
    exit 1
fi
TMP_DESKTOP_FILE=${LAUNCHER_INSTALL_DIR}/vsls-launcher.desktop
${PREFIX}sed -i "s/VSLS_LAUNCHER_INSTALL_DIR/$(echo ${LAUNCHER_INSTALL_DIR} | sed -r 's/\//\\\//g')/g" ${TMP_DESKTOP_FILE}  &> /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Failed replace path in desktop file"
    exit 1
fi

# Install desktop file (which deletes the also temp one)
${PREFIX}desktop-file-install --delete-original --rebuild-mime-info-cache --dir=${DESKTOP_INSTALL_DIR} ${TMP_DESKTOP_FILE} &> /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Failed to install desktop file to ${DESKTOP_INSTALL_DIR}"
    exit 1
fi

echo "(*) VS Live Share launcher installation complete!"
